let f=null,o=null,i=null,y=!0,g=0,u=!0;function D(){const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${n}`}function v(e){if(!e)return null;try{const t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"?t.hostname:null}catch{return null}}async function p(){const t=`usageData_${D()}`;try{let n=(await chrome.storage.local.get(t))[t];!n||typeof n!="object"||!n.domains?n={domains:{},sessions:1,hourly:{}}:n.sessions=(n.sessions||0)+1,await chrome.storage.local.set({[t]:n})}catch(a){console.error(a)}}async function l(){if(console.log(`Intentando saveTime. Domain: ${o} | StartTime: ${i}`),!o||!i)return;const e=Date.now(),t=Math.floor((e-i)/1e3);if(t<=0){i=Date.now();return}const a=new Date().getHours(),d=`usageData_${D()}`;try{let r=(await chrome.storage.local.get(d))[d];if(!r||typeof r!="object"||!r.domains){const S=r||{};r={domains:{},sessions:1,hourly:{}};for(const[b,w]of Object.entries(S))typeof w=="number"&&(r.domains[b]={timeSpent:w,visits:1})}const s=r;s.domains[o]||(s.domains[o]={timeSpent:0,visits:0}),s.domains[o].timeSpent+=t,u||(s.domains[o].visits+=1,u=!0),s.hourly[a]=(s.hourly[a]||0)+t,await chrome.storage.local.set({[d]:s}),console.log(`TIEMPO GUARDADO EXITÓSAMENTE: ${t}s añadidos al dominio ${o}`)}catch(h){console.error("Error saving time spent:",h)}i=Date.now()}async function c(e,t){console.log(`updateActiveTab lanzado para Tab: ${e}, URL original: ${t}`),await l(),f=e;const a=v(t);a?(a!==o&&(u=!1),console.log(`Dominio capturado y guardando como activo: ${a}`),o=a,i=Date.now()):(console.log("Desactivando timer. Dominio final nulo u omitido."),o=null,i=null)}chrome.tabs.onActivated.addListener(async e=>{try{const t=await chrome.tabs.get(e.tabId);await c(t.id,t.url)}catch{await c(e.tabId,void 0)}});chrome.tabs.onUpdated.addListener(async(e,t,a)=>{e===f&&(t.url||t.status==="complete")&&await c(e,a.url)});chrome.windows.onFocusChanged.addListener(async e=>{if(y=e!==chrome.windows.WINDOW_ID_NONE,!y)g=Date.now(),await l(),o=null,i=null;else{Date.now()-g>300*1e3&&await p();try{const[t]=await chrome.tabs.query({active:!0,windowId:e});t&&t.id&&await c(t.id,t.url)}catch(t){console.error(t)}}});async function m(){await p();try{const[e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(e&&e.id)await c(e.id,e.url);else{const[t]=await chrome.tabs.query({active:!0});t&&t.id&&await c(t.id,t.url)}}catch(e){console.error("Init error",e)}}chrome.runtime.onStartup.addListener(m);chrome.runtime.onInstalled.addListener(m);m();chrome.alarms.create("saveTimeAlarm",{periodInMinutes:1});chrome.alarms.onAlarm.addListener(e=>{e.name==="saveTimeAlarm"&&l()});chrome.runtime.onSuspend.addListener(()=>{l()});
